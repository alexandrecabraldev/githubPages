name: Security

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  SAST:
    name: Static Analysis (SAST)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run SAST checks
        run: |
          echo "üîç Executando SAST..."
          echo "Verificando arquivos HTML, CSS e JS..."

          # Busca apenas arquivos HTML, CSS e JS
          FILES=$(find . -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \))
          FOUND=""
          for f in $FILES; do
            if grep -q -E "(eval\(|innerHTML|document\.write|localStorage\.setItem)" "$f"; then
              FOUND="$FOUND\n $f cont√©m poss√≠veis riscos"
            fi
          done

          if [ -n "$FOUND" ]; then
            echo -e "$FOUND"
            exit 1
          else
            echo "Nenhum problema detectado no c√≥digo est√°tico."
          fi

  DAST:
    name: Dynamic Analysis (DAST)
    runs-on: ubuntu-latest
    needs: SAST  # S√≥ roda se o SAST passar

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start local server
        run: |
          echo "üöÄ Iniciando servidor local..."
          python3 -m http.server 8080 &
          sleep 5

      - name: Run DAST checks
        run: |
          echo "üåê Executando DAST..."
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080)
          if [ "$STATUS" -eq 200 ]; then
            echo "Aplica√ß√£o respondeu com sucesso (HTTP 200)"
          else
            echo "Falha ao acessar aplica√ß√£o (status: $STATUS)"
            exit 1
          fi
